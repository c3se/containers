bootstrap: docker
from: rstudio/r-base:4.1.2-focal

%post
    apt-get update -y

    # Download and install RStudio
    mkdir -p /workspace && cd /workspace
    wget -q "https://download2.rstudio.org/server/bionic/amd64/rstudio-server-2022.02.0-443-amd64.deb"
    #dpkg-i rstudio-*-amd64.deb
    apt install -y --no-install-recommends ./rstudio-*-amd64.deb
    rm rstudio-*-amd64.deb

    # RStudio wants an /etc/R
    mkdir -p /etc/R

    # Install R-package dependencies
    apt-get install -y libpng-dev libjpeg-dev

    # Install R packages
    sed -i 's|# options(repos.*$|options(repos = c(CRAN="https://cloud.r-project.org/"))|' /usr/lib/R/library/base/R/Rprofile
    R --slave -e 'install.packages("tensorflow")'
    R --slave -e "library(tensorflow); \
                  install_tensorflow(method=\"system\");"
    R --slave -e 'install.packages("torch")'
    R --slave -e 'install.packages("torchvision")'

    # Clean up to minimize container size
    apt-get clean
    rm -rf /var/lib/apt/lists/

    # Make image writable with overlays
    chmod a+rwX -fR /boot /bin /sbin /lib /lib32 /lib64 /usr /etc /var /opt || :

%environment
    PATH=/usr/lib/rstudio-server/bin:${PATH}
